name: Destroy Bootstrap Terraform (S3 + DynamoDB)

on:
  workflow_dispatch:
    inputs:
      var_file:
        description: "TFVARS file used for bootstrap (must exist in bootstrap folder)"
        required: false
        default: "bootstrap.tfvars"
      auto_approve:
        description: "Auto approve destroy (true/false)"
        required: false
        default: "true"

permissions:
  id-token: write
  contents: read

jobs:
  destroy:
    name: Destroy Bootstrap Resources
    runs-on: ubuntu-latest

    steps:
      # ------------------ CHECKOUT CODE ----------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------ AUTH WITH AWS OIDC ------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ------------------ INSTALL TERRAFORM + JQ --------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.6"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ------------------ TERRAFORM INIT ----------------------
      - name: Terraform init (NO backend)
        working-directory: ./bootstrap
        run: terraform init -backend=false -input=false

      # ------------------ READ VALUES FROM TERRAFORM.TFSTATE --
      - name: Read bucket & table from terraform.tfstate
        id: read_state
        working-directory: ./bootstrap
        run: |
          STATE="terraform.tfstate"
          if [ ! -f "$STATE" ]; then
            echo "ERROR: terraform.tfstate not found — bootstrap must be applied first."
            exit 1
          fi

          BUCKET=$(jq -r '.outputs.unique_bucket_name.value // empty' "$STATE")
          TABLE=$(jq -r '.outputs.dynamodb_table_name.value // empty' "$STATE")

          echo "Found bucket: $BUCKET"
          echo "Found table : $TABLE"

          echo "bucket_name=$BUCKET" >> "$GITHUB_OUTPUT"
          echo "dynamodb_table=$TABLE" >> "$GITHUB_OUTPUT"

      # ------------------ EMPTY S3 BUCKET ----------------------
      - name: Empty S3 bucket
        if: ${{ steps.read_state.outputs.bucket_name != '' }}
        run: |
          BUCKET="${{ steps.read_state.outputs.bucket_name }}"
          echo "Emptying S3 bucket: $BUCKET"
          aws s3 rm "s3://$BUCKET" --recursive || true
          echo "Bucket emptied."

      # ------------------ DELETE DYNAMODB TABLE ----------------
      - name: Delete DynamoDB table
        if: ${{ steps.read_state.outputs.dynamodb_table != '' }}
        run: |
          TABLE="${{ steps.read_state.outputs.dynamodb_table }}"
          echo "Deleting DynamoDB table: $TABLE"
          aws dynamodb delete-table --table-name "$TABLE" || true
          aws dynamodb wait table-not-exists --table-name "$TABLE" || true
          echo "Table deleted."

      # ------------------ TERRAFORM DESTROY --------------------
      - name: Terraform destroy (auto-approve)
        if: ${{ github.event.inputs.auto_approve == 'true' }}
        working-directory: ./bootstrap
        run: |
          TFVARS="${{ github.event.inputs.var_file }}"

          if [ -f "$TFVARS" ]; then
            echo "Destroying using TFVARS: $TFVARS"
            terraform destroy -auto-approve -var-file="$TFVARS"
          else
            echo "WARNING: No tfvars file found at $TFVARS — running without var-file"
            terraform destroy -auto-approve
          fi

      - name: Terraform destroy (manual confirm)
        if: ${{ github.event.inputs.auto_approve != 'true' }}
        working-directory: ./bootstrap
        run: |
          TFVARS="${{ github.event.inputs.var_file }}"

          if [ -f "$TFVARS" ]; then
            terraform destroy -var-file="$TFVARS"
          else
            terraform destroy
          fi

      # ------------------ FINISHED ------------------------------
      - name: Completed
        run: echo "Bootstrap destroy completed successfully."
