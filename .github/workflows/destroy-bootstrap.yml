name: Destroy Bootstrap Terraform (S3 + DynamoDB)

on:
  workflow_dispatch:
    inputs:
      var_file:
        description: "TFVARS file used in bootstrap"
        required: false
        default: "bootstrap.tfvars"
      auto_approve:
        description: "Auto approve destroy step (true/false)"
        required: false
        default: "true"

permissions:
  id-token: write
  contents: read

jobs:
  destroy:
    name: Destroy bootstrap resources
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.6"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Terraform init (no backend)
        working-directory: ./bootstrap
        run: terraform init -backend=false -input=false

      - name: Read outputs from tfstate
        id: read_state
        working-directory: ./bootstrap
        run: |
          STATE="terraform.tfstate"

          if [ ! -f "$STATE" ]; then
            echo "ERROR: terraform.tfstate not found. Cannot read outputs."
            exit 1
          fi

          BUCKET=$(jq -r '.outputs.unique_bucket_name.value // empty' "$STATE")
          TABLE=$(jq -r '.outputs.dynamodb_table_name.value // empty' "$STATE")

          echo "bucket_name=$BUCKET" >> "$GITHUB_OUTPUT"
          echo "dynamodb_table=$TABLE" >> "$GITHUB_OUTPUT"

          echo "Found bucket: $BUCKET"
          echo "Found table : $TABLE"

      # ---------------------------------------------------------
      # Empty S3 bucket
      # ---------------------------------------------------------
      - name: Empty S3 bucket
        if: ${{ steps.read_state.outputs.bucket_name != '' }}
        run: |
          BUCKET="${{ steps.read_state.outputs.bucket_name }}"
          echo "Removing all objects from bucket=$BUCKET"
          aws s3 rm "s3://$BUCKET" --recursive || true

      # ---------------------------------------------------------
      # Delete DynamoDB table
      # ---------------------------------------------------------
      - name: Delete DynamoDB table
        if: ${{ steps.read_state.outputs.dynamodb_table != '' }}
        run: |
          TABLE="${{ steps.read_state.outputs.dynamodb_table }}"
          echo "Deleting table=$TABLE"
          aws dynamodb delete-table --table-name "$TABLE" || true
          aws dynamodb wait table-not-exists --table-name "$TABLE" || true

      # ---------------------------------------------------------
      # Terraform destroy (using actual CRUD)
      # ---------------------------------------------------------
      - name: Terraform destroy (auto approve)
        if: ${{ github.event.inputs.auto_approve == 'true' }}
        working-directory: ./bootstrap
        run: terraform destroy -auto-approve

      - name: Terraform destroy (manual)
        if: ${{ github.event.inputs.auto_approve != 'true' }}
        working-directory: ./bootstrap
        run: terraform destroy

      - name: Completed
        run: echo "Bootstrap resources destroyed successfully."
