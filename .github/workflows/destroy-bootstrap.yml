name: Destroy Bootstrap Terraform (S3 Backend + DynamoDB Lock)

on:
  workflow_dispatch:
    inputs:
      var_file:
        description: "Optional tfvars file inside bootstrap directory"
        required: false
        default: "bootstrap.tfvars"
      auto_approve:
        description: "Auto approve terraform destroy (true/false)"
        required: false
        default: "true"

permissions:
  id-token: write
  contents: read

jobs:
  destroy:
    name: Destroy Bootstrap Resources
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # Checkout Code
      # --------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Configure AWS (OIDC role)
      # --------------------------------------------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # --------------------------------------------------------
      # Install Terraform + jq
      # --------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.6"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # --------------------------------------------------------
      # Initialize Terraform (NO backend)
      # --------------------------------------------------------
      - name: Terraform init (backend disabled)
        working-directory: ./bootstrap
        run: terraform init -backend=false -input=false

      # --------------------------------------------------------
      # Terraform validate
      # --------------------------------------------------------
      - name: Terraform validate
        working-directory: ./bootstrap
        run: terraform validate

      # --------------------------------------------------------
      # Terraform plan (destroy preview, safe)
      # --------------------------------------------------------
      - name: Terraform plan (destroy)
        id: plan
        working-directory: ./bootstrap
        run: |
          TFVARS="${{ github.event.inputs.var_file }}"

          if [ -f "${TFVARS}" ]; then
            terraform plan -destroy -input=false -var-file="${TFVARS}" -out=destroy.tfplan
          else
            terraform plan -destroy -input=false -out=destroy.tfplan
          fi

      # --------------------------------------------------------
      # Read Terraform outputs SAFELY using JSON
      # --------------------------------------------------------
      - name: Read Terraform outputs (clean + JSON-safe)
        id: tf_outputs
        working-directory: ./bootstrap
        run: |
          set -e
      
          echo "Running terraform output -json ..."
          terraform output -json > tf_raw.json 2>&1 || true
      
          echo "Raw terraform output:"
          sed -n '1,50p' tf_raw.json
      
          echo "Cleaning JSON..."
          # Remove everything BEFORE first '{'
          sed '0,/{/s/.*{//' tf_raw.json | sed '1s/^/{/' > tf_outputs.json
      
          echo "Cleaned terraform JSON:"
          sed -n '1,50p' tf_outputs.json
      
          # Validate cleaned JSON
          if ! jq -e . tf_outputs.json > /dev/null 2>&1; then
            echo "ERROR: cleaned JSON is still invalid"
            exit 1
          fi
      
          # Extract values
          BUCKET=$(jq -r '.unique_bucket_name.value // empty' tf_outputs.json)
          TABLE=$(jq -r '.dynamodb_table_name.value // empty' tf_outputs.json)
      
          echo "Final parsed bucket: $BUCKET"
          echo "Final parsed table: $TABLE"
      
          # Export to workflow outputs
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "table=$TABLE" >> $GITHUB_OUTPUT

      # --------------------------------------------------------
      # Empty S3 bucket BEFORE running destroy
      # --------------------------------------------------------
      - name: Empty S3 bucket
        if: ${{ steps.tf_outputs.outputs.bucket != '' }}
        run: |
          BUCKET="${{ steps.tf_outputs.outputs.bucket }}"
          echo "Emptying bucket: $BUCKET ..."
          aws s3 rm "s3://${BUCKET}" --recursive || true
          echo "Bucket emptied (or did not exist)."

      # --------------------------------------------------------
      # Delete DynamoDB table BEFORE destroy (to avoid TF hang)
      # --------------------------------------------------------
      - name: Delete DynamoDB lock table manually
        if: ${{ steps.tf_outputs.outputs.table != '' }}
        run: |
          TABLE="${{ steps.tf_outputs.outputs.table }}"
          echo "Deleting DynamoDB table: $TABLE ..."
          aws dynamodb delete-table --table-name "$TABLE" || true
          echo "Waiting for deletion..."
          aws dynamodb wait table-not-exists --table-name "$TABLE" || true
          echo "Table deletion complete or skipped."

      # --------------------------------------------------------
      # Terraform destroy
      # --------------------------------------------------------
      - name: Terraform destroy (auto-approve)
        if: ${{ github.event.inputs.auto_approve == 'true' }}
        working-directory: ./bootstrap
        run: terraform destroy -auto-approve destroy.tfplan

      - name: Terraform destroy (manual confirmation)
        if: ${{ github.event.inputs.auto_approve != 'true' }}
        working-directory: ./bootstrap
        run: terraform destroy destroy.tfplan

      # --------------------------------------------------------
      # Final Cleanup Log
      # --------------------------------------------------------
      - name: Completed
        run: echo "Bootstrap destroy workflow completed successfully."
