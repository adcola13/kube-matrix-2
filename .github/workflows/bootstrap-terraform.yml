name: Bootstrap Terraform (Create S3 backend + DynamoDB lock)

on:
  workflow_dispatch:
    inputs:
      var_file:
        description: "TFVARS file for bootstrap"
        required: false
        default: "bootstrap.tfvars"
      auto_approve:
        description: "Auto approve terraform apply (true/false)"
        required: false
        default: "true"

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap:
    name: Run Terraform Bootstrap
    runs-on: ubuntu-latest

    outputs:
      bucket_name: ${{ steps.read_state.outputs.bucket_name }}
      dynamodb_table: ${{ steps.read_state.outputs.dynamodb_table }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.6"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Terraform init (no backend)
        working-directory: ./bootstrap
        run: terraform init -backend=false -input=false

      - name: Terraform validate
        working-directory: ./bootstrap
        run: terraform validate

      - name: Terraform plan
        id: plan
        working-directory: ./bootstrap
        run: |
          TFVARS="${{ github.event.inputs.var_file }}"
          if [ -f "$TFVARS" ]; then
            terraform plan -input=false -var-file="$TFVARS" -out=tf.plan
          else
            terraform plan -input=false -out=tf.plan
          fi

      - name: Terraform apply
        if: ${{ github.event.inputs.auto_approve == 'true' }}
        working-directory: ./bootstrap
        run: terraform apply -auto-approve tf.plan

      - name: Terraform apply (manual confirmation)
        if: ${{ github.event.inputs.auto_approve != 'true' }}
        working-directory: ./bootstrap
        run: terraform apply tf.plan

      # -------------------------------------------------------
      # Extract bucket/table from terraform.tfstate (NO jq errors)
      # -------------------------------------------------------
      - name: Read outputs from tfstate
        id: read_state
        working-directory: ./bootstrap
        run: |
          STATE="terraform.tfstate"

          if [ ! -f "$STATE" ]; then
            echo "ERROR: State not found after tf apply!"
            exit 1
          fi

          BUCKET=$(jq -r '.outputs.unique_bucket_name.value // empty' "$STATE")
          TABLE=$(jq -r '.outputs.dynamodb_table_name.value // empty' "$STATE")

          echo "bucket_name=$BUCKET" >> "$GITHUB_OUTPUT"
          echo "dynamodb_table=$TABLE" >> "$GITHUB_OUTPUT"

          echo "Bootstrap Output:"
          echo "Bucket: $BUCKET"
          echo "DynamoDB Table: $TABLE"

